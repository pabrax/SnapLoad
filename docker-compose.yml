# Docker Compose Full Stack - Desarrollo/Testing Local
# Estructura esperada: SnapLoad/{snapLoad-API, snapLoad-UI}

version: "3.8"

services:
  snapload-ui:
    container_name: snapload-ui
    build:
      context: ./snapLoad-UI
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://snapload-api:8000
    image: snapload-ui:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - snapload-network
    depends_on:
      snapload-api:
        condition: service_healthy

  snapload-api:
    container_name: snapload-api
    build:
      context: ./snapLoad-API
      dockerfile: Dockerfile
    image: snapload-api:latest
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - WORKERS=1
      - RETENTION_HOURS=3
      - CLEANUP_CRON=0 * * * *
      - ENABLE_ADMIN_ENDPOINTS=false
    volumes:
      - api-downloads:/app/downloads
      - api-logs:/app/logs
      - api-meta:/app/meta
      - api-tmp:/app/tmp
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - snapload-network

volumes:
  api-downloads:
  api-logs:
  api-meta:
  api-tmp:

networks:
  snapload-network:
    driver: bridge
