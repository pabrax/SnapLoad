# Docker Compose Full Stack - Desarrollo/Testing Local
# Estructura esperada: SnapLoad/{snapLoad-API, snapLoad-UI}

version: "3.8"

services:
  snapload-api:
    container_name: snapload-api
    build:
      context: ./snapLoad-API
      dockerfile: Dockerfile
    image: snapload-api:latest
    restart: unless-stopped
    ports:
      - "9020:8000"
    environment:
      - PORT=8000
      - WORKERS=1
      - CLEANUP_SCHEDULE_ENABLED=true
      - RETENTION_HOURS=3
      - TEMP_RETENTION_HOURS=1
      - CLEANUP_CRON=0 * * * *
      - TEMP_CLEANUP_CRON=0 */30 * * *
      - CLEANUP_DRY_RUN=false
      - ENABLE_ADMIN_ENDPOINTS=false
      - CLEANUP_LOG_LEVEL=INFO
    volumes:
      - api-downloads:/app/downloads
      - api-logs:/app/logs
      - api-meta:/app/meta
      - api-tmp:/app/tmp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - snapload-network

  snapload-ui:
    container_name: snapload-ui
    build:
      context: ./snapLoad-UI
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://snapload-api:8000
    image: snapload-ui:latest
    restart: unless-stopped
    ports:
      - "9012:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - BACKEND_INTERNAL_URL=http://snapload-api:8000
      - NEXT_PUBLIC_BACKEND_URL=http://localhost:9020
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - snapload-network
    depends_on:
      snapload-api:
        condition: service_healthy

volumes:
  api-downloads:
  api-logs:
  api-meta:
  api-tmp:

networks:
  snapload-network:
    driver: bridge
